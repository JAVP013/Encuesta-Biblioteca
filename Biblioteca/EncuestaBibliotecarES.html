<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de Satisfacción de Servicios de Biblioteca - ITTEPIC</title>
    <link rel="stylesheet" href="/styles/styleBiblioteca.css">
</head>
<body>
<header class="titulo">
    <div class="div_img1">
        <img src="../imagenes/Logo-TecNM.png" class="imagenes" >
    </div>
    <div class="letras-titulo">
        <h1>Encuesta de Satisfacción de Servicios de Biblioteca</h1>
        <h2>Instituto Tecnológico de Tepic - ITTEPIC</h2>
    </div>
<div class="div_img">
    <img src="../imagenes/estepi.png" class="imagenes" >
</div>

</header>

<main class="estilo_mian">
    <p><strong>Evaluar el nivel de satisfacción que poseen los estudiantes que son usuarios del Centro de Información (CI).</strong></p>
    <p>El Centro de Información solicita su apoyo para contestar la siguiente encuesta sobre la satisfacción del usuario en relación con los servicios que se ofrecen en sus instalaciones.</p>
    <p>Le pedimos por favor responder el siguiente cuestionario.</p>
    
    <form id="formEncuesta" action="https://script.google.com/macros/s/AKfycbx16PtYSqRGpP9sFRgY4X9ohXucGJNSxxjEJlKkwsaYdV3aDCTQlerK5QrlB-m0fhvPcQ/exec" method="post">

        <!-- Numero de control -->
        <label for="text">Numero de control:</label><br>
        <input type="textbox" id="nocontrol" name="nocontrol" placeholder="Numero de control" required >
        <span id="error" style="color:red; display:none;">Formato inválido</span>
        <br><br>

        <!-- Semestre -->
        <!-- Campo oculto para el semestre -->
        <input type="hidden" id="semestre" name="semestre">

        <!-- Carrera -->
        <label for="carrera">Selecciona la carrera que estás cursando en la institución:</label><br>
        <select id="carrera" name="carrera" required>
            <option value="Industrial">ING. INDUSTRIAL</option>
            <option value="Electrica">ING. ELÉCTRICA</option>
            <option value="Mecatronica">ING. MECATRÓNICA</option>
            <option value="Gestion">ING. EN GESTIÓN EMPRESARIAL</option>
            <option value="Civil">ING. CIVIL</option>
            <option value="Quimica">ING. QUÍMICA</option>
            <option value="Bioquimica">ING. BIOQUÍMICA</option>
            <option value="Sistemas Computacionales">ING. EN SISTEMAS COMPUTACIONALES</option>
            <option value="Tic's">ING. EN TECNOLOGÍAS DE LA INFORMACIÓN Y COMUNICACIONES</option>
            <option value="Administracion">LIC. EN ADMINISTRACIÓN</option>
            <option value="Arquitectura">ARQUITECTURA</option>
            <option value="Ma. en Alimento">MAESTRIA EN CIENCIAS EN ALIMENTO</option>
            <option value="Doc. en Alimento">DOCTORADO EN CIENCIAS EN ALIMENTO</option>
        </select><br><br>

        <!-- Género -->
        <label for="genero">Selecciona el género:</label><br>
        <select id="genero" name="genero" required>
            <option value="Femenino">FEMENINO</option>
            <option value="Masculino">MASCULINO</option>
            <option value="Otro">OTRO / INDISTINTO</option>
        </select><br><br>

        <!-- Pregs de satisfacción -->
        <h2>Preguntas de satisfacción</h2>
        <div id="preguntas-container"></div>

        <span id="error_preg" class="error"></span>
        <br><br>
        <input type="submit" value="Enviar encuesta">
    </form>
</main>
<footer>
    <p>Instituto Tecnológico de Tepic - ITTEPIC | Centro de Información</p>
</footer>
<script>
    const numeroControl = document.getElementById('nocontrol');
const formulario = document.getElementById('formEncuesta');
const errorMensaje = document.getElementById('error');
const semestreInput = document.getElementById('semestre');

//************************************ Expresión regular para validar el número de control ************************************
const regex = /^[CD]?0[89]40[0-9]{4}$|^[CD]?1[0-9]40[0-9]{4}$|^[CD]?2[103]40[0-9]{4}$/;

// ************************************Carga las preguntas desde Google Sheets al cargar la página************************************
document.addEventListener('DOMContentLoaded', fetchQuestions);

// ************************************ Función para obtener preguntas desde Google Sheets ************************************
async function fetchQuestions() {
    const API_KEY = 'AIzaSyD_1OHIUxyQpIcyLgUY0y-NZKo09jmm0mo'; // Tu API key
    const SPREADSHEET_ID = '1YAF_8hFmUGA7GatIRKFnJdHhWR9ZNKJwp6_cSMkv4KE'; // Tu Spreadsheet ID
    const RANGE = 'Preguntas!A2:F30'; // Tu rango

    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`);
    const data = await response.json();
    const questions = data.values;

    if (questions.length > 0) {
        displayQuestions(questions);
    }
}

//******************************** Función para mostrar las preguntas en el formulario ************************************
function displayQuestions(questions) {
    const container = document.getElementById('preguntas-container');

    questions.forEach((row, index) => {
        const questionLabel = document.createElement('label');
        questionLabel.innerText = row[0]; // Primera columna es la pregunta
        container.appendChild(questionLabel);

        const optionsDiv = document.createElement('div');
        const options = row.slice(1).filter(option => option !== ""); // Filtramos las opciones vacías
        
        // Si no hay opciones, asumimos que es una pregunta de texto
        if (options.length === 0) {
            const textBox = document.createElement('input');
            textBox.type = 'textbox';
            textBox.name = `preg${index + 1}`;
            textBox.placeholder = 'Observaciones';
            textBox.className = 'optional'; // Marcamos las preguntas abiertas como opcionales
            optionsDiv.appendChild(textBox);
        } else {
            // Si todas las opciones son valores de satisfacción ("EXCELENTE", "BUENO", etc.)
            const isEmojiQuestion = options.every(option => ["EXCELENTE", "BUENO", "REGULAR", "MALO", "MUY MALO"].includes(option));
            if (isEmojiQuestion) {
                optionsDiv.className = 'emoji-options';
                const emojis = {
                    "5": "😀",
                    "4": "😊",
                    "3": "😐",
                    "2": "☹️",
                    "1": "😠"
                };

                // Asignar IDs en el formato "preg#_#"
                Object.keys(emojis).forEach((option, optionIndex) => {
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `preg${index + 1}`; // Agrupando las respuestas por pregunta
                    input.value = option;
                    input.id = `preg${index + 1}_${optionIndex + 1}`; // ID numérico en el formato "preg#_#"

                    label.appendChild(input);
                    const emojiSpan = document.createElement('span');
                    emojiSpan.textContent = emojis[option];
                    label.appendChild(emojiSpan);
                    optionsDiv.appendChild(label);
                });
            } else {
                // Caso general para las opciones de texto
                optionsDiv.className = 'letras-options';
                
                options.forEach((option, optionIndex) => {
                    if (option !== "") {
                        const label = document.createElement('label');
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = `preg${index + 1}`; // Agrupando las respuestas por pregunta
                        input.value = option;
                        input.id = `preg${index + 1}_${optionIndex + 1}`; // ID numérico en el formato "preg#_#"

                        label.appendChild(input);
                        const textSpan = document.createElement('span');
                        textSpan.textContent = option;
                        label.appendChild(textSpan);
                        optionsDiv.appendChild(label);
                    }
                });
            }
        }

        // Agregar las opciones y los campos de error al contenedor
        container.appendChild(optionsDiv);
        container.appendChild(document.createElement('br'));

        const errorSpan = document.createElement('span');
        errorSpan.className = 'error';
        errorSpan.style.color = 'red'; 
        container.appendChild(errorSpan); 
    });
}

// ************************************ Validar el número de control ************************************
numeroControl.addEventListener('input', function() {
    if (regex.test(numeroControl.value)) {
        errorMensaje.style.display = 'none';
        numeroControl.style.borderColor = 'green';
        calcularSemestre(numeroControl.value);
    } else {
        errorMensaje.style.display = 'inline';
        numeroControl.style.borderColor = 'red';
    }
});

// *********************************** Calcular el semestre automáticamente ********************************
function calcularSemestre(nocontrol) {
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;

    let cleanControlNumber = nocontrol;
    if (nocontrol.startsWith('C') || nocontrol.startsWith('D')) {
        cleanControlNumber = nocontrol.substring(1);
    }

    let yearEntered = parseInt(cleanControlNumber.substring(0, 2), 10);
    let yearFull = (yearEntered < 50) ? 2000 + yearEntered : 1900 + yearEntered;

    let yearsSinceEntry = currentYear - yearFull;
    let semestresTranscurridos = yearsSinceEntry * 2;

    if (currentMonth >= 8) {
        semestresTranscurridos += 1;
    } else if (yearsSinceEntry >= 1) {
        semestresTranscurridos += 2;
    }

    semestreInput.value = semestresTranscurridos;
}
// ************************************ PREGUNTAS ************************************
document.addEventListener('DOMContentLoaded', function() {
    // Pregunta 11 y 12
    const preg11Elements = document.querySelectorAll('input[name="preg11"]');
    const preg12_manana = document.getElementById('input[id=preg12_1]');
    const preg12_tarde = document.getElementById('input[id=preg12_2]');
    const preg12_mixto = document.getElementById('input[id=preg12_3]');
    const preg12_nouso = document.getElementById('input[id=preg12_4]');

    preg11Elements.forEach((element) => {
        element.addEventListener('change', function() {
            if (document.getElementById('preg11_5').checked) { // Si se selecciona "nunca" en pregunta 11
                preg12_nouso.checked = true;
                preg12_nouso.disabled = false;

                // Deshabilitar otras opciones de pregunta 12
                preg12_manana.disabled = true;
                preg12_tarde.disabled = true;
                preg12_mixto.disabled = true;
            } else {
                // Habilitar las opciones de pregunta 12
                preg12_manana.disabled = false;
                preg12_tarde.disabled = false;
                preg12_mixto.disabled = false;
                preg12_nouso.disabled = true;
            }
        });
    });

    // Pregunta 13, 14 y 15
    const preg13Elements = document.querySelectorAll('input[name="preg13"]');
    const preg14_siempre = document.getElementById('preg14_1');
    const preg14_23veces = document.getElementById('preg14_2');
    const preg14_1vez = document.getElementById('preg14_3');
    const preg14_nunca = document.getElementById('preg14_4');
    const preg15_si = document.getElementById('preg15_1');
    const preg15_no = document.getElementById('preg15_2');

    preg13Elements.forEach((element) => {
        element.addEventListener('change', function() {
            if (document.getElementById('preg13_2').checked || document.getElementById('preg13_3').checked) { 
                // Si se selecciona "no" o "no enterado" en pregunta 13
                preg14_nunca.checked = true;
                preg15_no.checked = true;

                // Deshabilitar preguntas 14 y 15
                preg14_siempre.disabled = true;
                preg14_23veces.disabled = true;
                preg14_1vez.disabled = true;
                preg15_si.disabled = true;
            } else {
                // Habilitar preguntas 14 y 15
                preg14_siempre.disabled = false;
                preg14_23veces.disabled = false;
                preg14_1vez.disabled = false;
                preg15_si.disabled = false;

                // Deshabilitar "nunca" en pregunta 14 si se selecciona "sí" en pregunta 13
                preg14_nunca.disabled = document.getElementById('preg13_1').checked;
            }
        });
    });
});


// ************************************ Validar el formulario al enviarlo ************************************
formulario.addEventListener('submit', function(event) {
    event.preventDefault(); 
    let valid = true; 

    if (!regex.test(numeroControl.value)) {
        alert("Por favor, ingresa un número de control válido con el formato adecuado.");
        return; 
    }

    const errorElements = document.querySelectorAll('.error');
    errorElements.forEach(el => el.textContent = ""); 

    const totalPreguntas = document.querySelectorAll('#preguntas-container > div'); 
    totalPreguntas.forEach((questionGroup, i) => {
        const radioInputs = questionGroup.querySelectorAll('input[type="radio"]');
        const textInput = questionGroup.querySelector('input[type="text"]');

        if (radioInputs.length > 0) {
            let answered = Array.from(radioInputs).some(input => input.checked); 
        
            if (!answered) {
                valid = false; 
                errorElements[i].textContent = "Por favor, conteste esta pregunta.";
            }
        }

        if (textInput && textInput.classList.contains('optional') && textInput.value.trim() === "") {
            valid = false;
            errorElements[i].textContent = "Por favor, complete este campo.";
        }
    });

    if (valid) {
        formulario.submit(); 
    } else {
        document.getElementById('error_preg').textContent = "Por favor, complete todas las preguntas obligatorias.";
    }
});

</script>
</body>
</html>



