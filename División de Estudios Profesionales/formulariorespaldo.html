<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de Satisfacción División de Estudios Profesionales - ITTEPIC</title>
    <link rel="stylesheet" href="/styles/styleDivisionEstudios.css">
</head>
<body>
<header class="titulo">
    <div class="div_img1">
        <img src="../imagenes/Logo-TecNM.png" class="imagenes">
    </div>
    <div class="letras-titulo">
        <h1>Encuesta de Satisfacción División de Estudios Profesionales</h1>
        <h2>Instituto Tecnológico de Tepic - ITTEPIC</h2>
    </div>
    <div class="div_img">
        <img src="../imagenes/estepi.png" class="imagenes">
    </div>
</header>

<main class="estilo_mian">
    <p><strong>Las respuestas van enfocadas únicamente al desarrollo de tu acto recepcional. Favor de leer atentamente y contestar sinceramente</strong></p>
    
    <form id="formEncuesta" action="https://script.google.com/a/macros/ittepic.edu.mx/s/AKfycbwFvXEhflHNkp1G7kAXvpNro3y83I-_4PG5aVSIWgb55GfegiHecQCfC5HEC_J6Hi8gjQ/exec" method="post">
        <!-- Numero de control -->
        <label for="nocontrol">Número de control:</label><br>
        <input type="textbox" id="nocontrol" name="nocontrol" placeholder="Número de control" required>
        <span id="error" style="color:red; display:none;">Formato inválido</span>
        <br><br>

        <!-- Campo oculto para el semestre -->
        <input type="hidden" id="semestre" name="semestre">

        <!-- Carrera -->
        <label for="carrera">Selecciona la carrera que estás cursando en la institución:</label><br>
        <select id="carrera" name="carrera" required>
            <option value="Industrial">ING. INDUSTRIAL</option>
            <option value="Electrica">ING. ELÉCTRICA</option>
            <option value="Mecatronica">ING. MECATRÓNICA</option>
            <option value="Gestion">ING. EN GESTIÓN EMPRESARIAL</option>
            <option value="Civil">ING. CIVIL</option>
            <option value="Quimica">ING. QUÍMICA</option>
            <option value="Bioquimica">ING. BIOQUÍMICA</option>
            <option value="Sistemas Computacionales">ING. EN SISTEMAS COMPUTACIONALES</option>
            <option value="Tic's">ING. EN TECNOLOGÍAS DE LA INFORMACIÓN Y COMUNICACIONES</option>
            <option value="Administracion">LIC. EN ADMINISTRACIÓN</option>
            <option value="Arquitectura">ARQUITECTURA</option>
            <option value="Ma. en Alimento">MAESTRÍA EN CIENCIAS EN ALIMENTO</option>
            <option value="Doc. en Alimento">DOCTORADO EN CIENCIAS EN ALIMENTO</option>
        </select><br><br>

        <!-- Género -->
        <label for="genero">Selecciona el género:</label><br>
        <select id="genero" name="genero" required>
            <option value="Femenino">FEMENINO</option>
            <option value="Masculino">MASCULINO</option>
            <option value="Otro">OTRO / INDISTINTO</option>
        </select><br><br>

        <!-- Preguntas dinámicas -->
        <h2>Preguntas de satisfacción</h2>
        <div id="preguntas-container"></div>

        <!-- Preg 7 abierta -->
        <label for="preg7">Alguna observación o recomendación para mejorar el proceso:</label><br>
        <input type="textbox" id="preg7" name="preg7" placeholder="Observaciones"><br><br>

        <input type="hidden" id="fechaHora" name="fechaHora">

        <span id="error_preg" class="error"></span>
        <br><br>
        <input type="submit" value="Enviar encuesta">
    </form>
</main>
<footer>
    <p>Instituto Tecnológico de Tepic - ITTEPIC | Centro de Información</p>
</footer>

<script>
    async function fetchQuestions() {
        const API_KEY = 'AIzaSyD_1OHIUxyQpIcyLgUY0y-NZKo09jmm0mo'; // Tu API key
        const SPREADSHEET_ID = '1SSGrHG9VwXRXX5QlxuXzRVZh5iuzY6WYzSXQopm_e6g'; // Tu Spreadsheet ID
        const RANGE = 'Preguntas!A2:F15'; // Tu rango
    
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`);
        const data = await response.json();
        const questions = data.values;
    
        if (questions.length > 0) {
            displayQuestions(questions);
        }
    }
    
    function displayQuestions(questions) {
        const container = document.getElementById('preguntas-container');

        questions.forEach((row, index) => {
            const questionLabel = document.createElement('label');
            questionLabel.innerText = row[0]; // Primera columna es la pregunta
            container.appendChild(questionLabel);
            
            const optionsDiv = document.createElement('div');
            
            // Verificar si la pregunta es sobre satisfacción
            if (row[0].toLowerCase().includes('satisfecho') | row[0].toLowerCase().includes('calificarías')) {
                optionsDiv.className = 'emoji-options';
                const emojis = {
                    "Altamente satisfecho": "😀",
                    "Muy satisfecho": "😊",
                    "Satisfecho": "😐",
                    "Poco satisfecho": "☹️",
                    "Completamente insatisfecho": "😠"
                };

                // Crear las opciones con emojis
                Object.keys(emojis).forEach(option => {
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `preg${index + 1}`; // Agrupando las respuestas por pregunta
                    input.value = option;

                    label.appendChild(input);
                    const emojiSpan = document.createElement('span'); // Crear el span para el emoji
                    emojiSpan.textContent = emojis[option]; // Añadir el emoji al span
                    label.appendChild(emojiSpan); // Añadir el span al label
                    optionsDiv.appendChild(label);
                });
            } else {
                optionsDiv.className = 'letras-options';
                // Las opciones de respuesta están en columnas posteriores
                const options = row.slice(1); // Suponiendo que las opciones empiezan en la segunda columna

                options.forEach((option) => {
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `preg${index + 1}`; // Agrupando las respuestas por pregunta
                    input.value = option;

                    label.appendChild(input);
                    const textSpan = document.createElement('span'); // Crear el span para el texto
                    textSpan.textContent = option; // Añadir el texto al span
                    label.appendChild(textSpan); // Añadir el span al label
                    optionsDiv.appendChild(label);
                });
            }

            container.appendChild(optionsDiv);
            container.appendChild(document.createElement('br'));

            const errorSpan = document.createElement('span');
            errorSpan.className = 'error';
            errorSpan.style.color = 'red'; // Para el color del error
            container.appendChild(errorSpan); // Añadir espacio para errores
        });
    }
    
    // Validar el número de control
    const numeroControl = document.getElementById('nocontrol');
    const formulario = document.getElementById('formEncuesta');
    const errorMensaje = document.getElementById('error');
    const semestreInput = document.getElementById('semestre');

    // Expresión regular para validar el número de control
    let regex = /^[CD]?0[89]40[0-9]{4}$|^[CD]?1[0-9]40[0-9]{4}$|^[CD]?2[103]40[0-9]{4}$/;

    numeroControl.addEventListener('input', function() {
        if (regex.test(numeroControl.value)) {
            errorMensaje.style.display = 'none';
            numeroControl.style.borderColor = 'green';
            calcularSemestre(numeroControl.value);
        } else {
            errorMensaje.style.display = 'inline';
            numeroControl.style.borderColor = 'red';
        }
    });

    // Calcular el semestre automáticamente
    function calcularSemestre(nocontrol) {
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;

        let cleanControlNumber = nocontrol;
        if (nocontrol.startsWith('C') || nocontrol.startsWith('D')) {
            cleanControlNumber = nocontrol.substring(1);
        }

        let yearEntered = parseInt(cleanControlNumber.substring(0, 2), 10);
        let yearFull = (yearEntered < 50) ? 2000 + yearEntered : 1900 + yearEntered;

        let yearsSinceEntry = currentYear - yearFull;
        let semestresTranscurridos = yearsSinceEntry * 2;

        if (currentMonth >= 8) {
            semestresTranscurridos += 1;
        } else if (yearsSinceEntry >= 1) {
            semestresTranscurridos += 2;
        }

        semestreInput.value = semestresTranscurridos;
    }

    formulario.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevenir el envío inmediato del formulario
        let valid = true; // Inicializa valid en true
        
        // Validar el número de control
        if (!regex.test(numeroControl.value)) {
            alert("Por favor, ingresa un número de control válido con el formato adecuado.");
            return; // Salir si el número de control es inválido
        }
        
        // Limpiar mensajes de error previos
        const errorElements = document.querySelectorAll('.error');
        errorElements.forEach(el => el.textContent = ""); 
        
        // Validar preguntas
        const totalPreguntas = document.querySelectorAll('[id^="preguntas-container"] input[type="radio"]').length; // Contar total de preguntas
        const questionGroups = document.querySelectorAll('#preguntas-container > div'); // Grupos de opciones
        for (let i = 0; i < questionGroups.length; i++) {
            const inputs = questionGroups[i].querySelectorAll('input[type="radio"]');
            let answered = Array.from(inputs).some(input => input.checked); // Revisar si alguna respuesta fue seleccionada
        
            if (!answered) {
                valid = false; // Cambiar valid a false si no se ha respondido
                errorElements[i].textContent = "Por favor, conteste esta pregunta.";
            }
        }
        console.log(valid);
        // Si todas las validaciones son correctas
        if (valid) {
            formulario.submit(); // Enviar el formulario si es válido
        } else {
            document.getElementById('error_preg').textContent = "Por favor, complete todas las preguntas.";
        }
    });
       

    // Carga las preguntas al cargar la página
    document.addEventListener('DOMContentLoaded', fetchQuestions);
</script>


</body>
</html>
